<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - objects controls</title>
		<meta charset="utf-8">
		<style>
			body {
				margin: 0px;
				color: #fff;
				font-family:Monospace;
				text-align: center;
				font-size: 15px;
				line-height: 30px;
				overflow: hidden;
			}
			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 15px;
				z-index:100;
			}
		</style>
	</head>
	<body>
		<div id="info">
			<a href="http://threejs.org" target="_blank">three.js</a> - look console
		</div>

		<script src="../build/three.min.js"></script>
		<script src="js/loaders/MTLLoader.js"></script>
		<script src="js/loaders/OBJMTLLoader.js"></script>

		<script src="js/libs/stats.min.js"></script>

		<script src="js/controls/OrbitControls.js"></script>		
		<script src="js/controls/EventsControls.js"></script>

		<script>


			var camera, scene, renderer, controls; 
			var model;

			init();
			animate();

			function init() {


				var sssr = '';
				for ( var i = 0; i < 8; i ++ ) {
					sssr = sssr + '<span id = "sound' + String( i )  + '"> </span>\n'; 
				}

				document.body.innerHTML = document.body.innerHTML + sssr;

				renderer = new THREE.WebGLRenderer( { antialias: true } ); 
				renderer.setClearColor( 0x6495ED );
				//renderer.setSize( 800, 500 );
				renderer.setSize( window.innerWidth, window.innerHeight );				
				document.body.appendChild( renderer.domElement );

				//

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				stats.domElement.style.zIndex = 100;
				document.body.appendChild( stats.domElement );

				//

				//camera = new THREE.PerspectiveCamera( 30, 800 / 500, 1, 2000 );
				camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 1, 2000 );				
				camera.position.set( 100, 400, 600 );
				camera.lookAt( new THREE.Vector3( 0, 0, 0 ) );

				controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.rotateSpeed = 1;
				controls.noZoom = false;
				controls.zoomSpeed = 1.2;
				controls.staticMoving = true;
				controls.minPolarAngle = Math.PI / 3;
				controls.maxPolarAngle = Math.PI / 3;

				scene = new THREE.Scene();

				var light = new THREE.DirectionalLight( 0xffffff, 1 );
				light.position.set( 0, 500, 1000 );
				scene.add( light );

				var light = new THREE.AmbientLight( 0x222222 );
				scene.add( light );


				// world

				var Texture = new THREE.ImageUtils.loadTexture( 'textures/checkerboard.jpg' );
				Texture.wrapS = Texture.wrapT = THREE.RepeatWrapping;
				Texture.repeat.set( 4, 4 );	Texture.offset.set( 0.5, 0 );

				var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide } );
				var Geometry = new THREE.PlaneGeometry( 400, 400, 1, 1 );

				var checkerboard = new THREE.Mesh( Geometry, Material );
				checkerboard.position.y = - 1;
				checkerboard.rotation.x =  Math.PI / 2;
				scene.add( checkerboard );


				EventsControls1 = new EventsControls( camera, renderer.domElement );
				EventsControls1.projectionMap = checkerboard; EventsControls1.fixed.y = true;				
					
				var radius = 20, h = 16, segments = 36;
				var geometry = new THREE.CylinderGeometry( radius, radius, h, segments );
				var material = new THREE.MeshPhongMaterial( { color: 0xFFFFF0 } );

				var checker = new THREE.Mesh( geometry, material );

				checker.position.set( -175, h / 2, 175 );
				scene.add( checker ); EventsControls1.attach( checker );

				var checker = new THREE.Mesh( geometry, material );

				checker.position.set( -75, h / 2, 175 );
				scene.add( checker ); EventsControls1.attach( checker );
				
				var object3D = new THREE.Object3D;
				var mesh = new THREE.Mesh( geometry, material );
				object3D.add( mesh ); 
				var mesh = new THREE.Mesh( geometry, material );
				mesh.position.y = h; mesh.rotation.x = Math.PI / 2; mesh.rotation.z = Math.PI / 2;
				object3D.add( mesh );
				object3D.position.set( 25, h / 2, 175 );				
				scene.add( object3D );  EventsControls1.attach( object3D );				

			
				var loader = new THREE.OBJMTLLoader();	
					loader.load( 'models/objmtl/model.obj', 'models/objmtl/model.mtl', 
						function ( GingerbreadMan ) {
							GingerbreadMan.position.set( 125, 35, 175 );
							GingerbreadMan.scale.set( 1/3, 1/3, 1/3 );
							scene.add( GingerbreadMan );
							EventsControls1.attach( GingerbreadMan );
						}
					);				
				

				EventsControls2 = new EventsControls( camera, renderer.domElement );
				EventsControls2.projectionMap = checkerboard; EventsControls2.fixed.y = true;
				EventsControls2.mouseMove = function() {
				
					this.container.style.cursor = 'move'
					this.focused.position.x = 25 + 50 * Math.round( ( this.focused.position.x - 25 ) / 50 );
					this.focused.position.z = 25 + 50 * Math.round( ( this.focused.position.z - 25 ) / 50 );

				}

				EventsControls2.mouseUp = function() {

					var x = ( this.focused.position.x - 25 ) / 50;
					var z = ( this.focused.position.z - 25 ) / 50;
					
					var sum = Math.abs( ( x + z ) % 2 );
					if ( sum == 0 ) { this.returnPrevious() }
					this.container.style.cursor = 'auto';

				}


				var radius = 20, h = 16, segments = 36;
				var geometry = new THREE.CylinderGeometry( radius, radius, h, segments );
				var material = new THREE.MeshPhongMaterial( { color: 0x9B2D30 } );

				var checker = new THREE.Mesh( geometry, material ); checker.name = 'checker';

				checker.position.set( -125, h / 2, 125 );
				scene.add( checker ); EventsControls2.attach( checker );

				
				var object3D = new THREE.Object3D; object3D.name = 'two checkers';
				var mesh = new THREE.Mesh( geometry, material.clone() );
				object3D.add( mesh ); mesh.name = 'bottom checker';
				var mesh = new THREE.Mesh( geometry, material.clone() );
				mesh.position.y = h; mesh.rotation.x = Math.PI / 2; mesh.rotation.z = Math.PI / 2;
				object3D.add( mesh );  mesh.name = 'top checker';
				object3D.position.set( -25, h / 2, 125 );				
				scene.add( object3D );  EventsControls2.attach( object3D );	


				var jsonLoader = new THREE.JSONLoader();
				jsonLoader.load( "models/Tux.js", addModelToScene );


				EventsControls3 = new EventsControls( camera, renderer.domElement );
				EventsControls3.projectionMap = checkerboard; EventsControls3.fixed.y = true;

				EventsControls3.onclick = function() {

					var mesh = new THREE.Mesh( this.focused.geometry.clone(), this.focused.material.clone() );
					mesh.position.copy( this.focused.position );
					mesh.material.transparent = true; mesh.material.opacity = 0.7;					
					scene.add( mesh );
					this.setFocus( mesh );

				}

				EventsControls3.mouseUp = function() {

					this.focused.material.transparent = false;
					this.container.style.cursor = 'auto';

				}

				var radius = 20, h = 16, segments = 36;
				var geometry = new THREE.CylinderGeometry( radius, radius, h, segments );
				var material = new THREE.MeshPhongMaterial( { color: 0xFF00FF } );

				var checker = new THREE.Mesh( geometry, material );

				checker.position.set( -175, h / 2, 75 ); checker.scale.set( 1/2, 1/2, 1/2 );
				scene.add( checker ); EventsControls3.attach( checker );


				// piano


				var autoMaterial = new THREE.MeshPhongMaterial( { color: 0x6a2089 } );
				var selMaterial = new THREE.MeshPhongMaterial( { color: 0x00d9ff } );


				EventsControls4 = new EventsControls( camera, renderer.domElement );
				EventsControls4.draggable = false;
				
				EventsControls4.mouseOver = function () {
					this.container.style.cursor = 'pointer';
					this.mouseOvered.material = selMaterial;
					console.log( 'the key at number ' + this.mouseOveredItem + ' is select' );							
				}

				EventsControls4.mouseOut = function () {
					this.container.style.cursor = 'auto';
					this.mouseOvered.material = autoMaterial;						
				}

				EventsControls4.onclick = function() {
					this.focused.position.y = -10; 
					DHTMLSound( 'snd/' + String( this.focusedItem ) + '.mp3', 'sound' + String( this.focusedItem ), ' ' );
					console.log('/--------------------/');
					console.log( 'the key at number ' + this.focusedItem + ' is pressed' );				
				}

				var geometry = new THREE.BoxGeometry( 20, 20, 80 );

				for ( var i = 0; i < 8; i ++ ) {

					var object = new THREE.Mesh( geometry, autoMaterial	);
					object.position.set( i * 40 - 140, 10, -250 );
					scene.add( object );
					EventsControls4.attach( object );

				}


				//


				EventsControls5 = new EventsControls( camera, renderer.domElement );
				EventsControls5.draggable = false; EventsControls5.attach( checkerboard );
				
				EventsControls5.mouseOver = function () {
					controls.enabled = false;
				}

				EventsControls5.mouseOut = function () {
					controls.enabled = true;
				}


				// Snowman


				EventsControls6 = new EventsControls( camera, renderer.domElement );
				EventsControls6.draggable = false;

				EventsControls6.onclick = function() {

					console.log('/--------------------/');
					console.log( 'this.focused.name: ' + this.focused.name );
					if ( this.focusedChild != null ) console.log( 'this.focusedChild.name: ' + this.focusedChild.name )
						else  console.log( 'this.focusedChild is null' );
					
					console.log( 'this.focusedDistance: ' + this.focusedDistance );
					
					console.log( 'this.focusedPoint: (' + this.focusedPoint.x + ', ' + this.focusedPoint.y + ', ' + this.focusedPoint.z + ')' );
					// OR
					console.log( 'this.focusedDistance: ' + this.intersects[0].distance );					
					console.log( 'this.focusedPoint: (' + this.intersects[0].point.x + ', ' + this.intersects[0].point.y + ', ' + this.intersects[0].point.z + ')' );

				}

				var man = createSnowman(); 
				man.position.set( 175, 0, 75 );
				scene.add( man ); 

				EventsControls6.attach( man );


/*
				// Sphere



				var geometry = new THREE.SphereGeometry( 200, 24, 24 );
				var material = new THREE.MeshLambertMaterial( { color: 0xFFCCFF, side: THREE.DoubleSide, wireframe: true } );
				Spheree = new THREE.Mesh( geometry, material );
			//	Spheree.position.x = -400;
				Spheree.position.y = 0;
				scene.add ( Spheree );

				EventsControls7 = new EventsControls( camera, renderer.domElement );
				EventsControls7.projectionMap = Spheree;

				EventsControls7.mouseOver = function () {
					this.container.style.cursor = 'pointer';
					controls.enabled = false;
				}

				EventsControls7.mouseOut = function () {
					this.container.style.cursor = 'auto';				
					controls.enabled = true;
				}

				EventsControls7.mouseMove = function() {
				
					this.container.style.cursor = 'move';
					this.focused.lookAt( this.intersectsMap[ 0 ].face.normal );
					this.focused.position.set( 0, 0, 0 );
					this.focused.position.copy( this.intersectsMap[ 0 ].point );

				}

				
				var geometry = new THREE.CylinderGeometry( 0, 20, 100, 3 );
				geometry.applyMatrix( new THREE.Matrix4().makeTranslation( 0, 50, 0 ) );
				geometry.applyMatrix( new THREE.Matrix4().makeRotationZ( Math.PI / 2 ) );
				helper = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial( { color: 0xCCCCFF } ) );
				helper.position.set( -200, 0, 0 );
				scene.add( helper );
			
				EventsControls7.attach( helper );			
	*/			
			}

			function addModelToScene( geometry, materials ) {

				var material = new THREE.MeshFaceMaterial( materials );
				model = new THREE.Mesh( geometry, material );
				model.scale.set( 10, 10, 10 ); model.name = 'Tux';
				model.rotation.x = -Math.PI/2; 
				model.position.set( 75, 45, 125 );
				scene.add( model ); EventsControls2.attach( model );
	
			}

			function DHTMLSound( audioSrc, id, loop ) {

					try {
						document.getElementById( id ).innerHTML = 
						' <audio src=" ' + audioSrc + 
						' " autoplay="autoplay" ' + loop + 
						' ></audio> ';
					}
					catch(exception) {}

			}

			function createSnowman() {
			
					var Snowman = new THREE.Object3D();
	
					var	material =  new THREE.MeshBasicMaterial({color: 0x33CCFF});
					var geometry = new THREE.SphereGeometry( 30, 36, 36 );
					var sphere1 = new THREE.Mesh( geometry, material);
					sphere1.position.set( 0, 30, 0 ); sphere1.name = 'sphere1';
					Snowman.add( sphere1 );

	
					var	material =  new THREE.MeshBasicMaterial({color: 0x00edff});
					var geometry = new THREE.SphereGeometry( 22, 36, 36 );
					var sphere2 = new THREE.Mesh( geometry, material); 					
					sphere2.position.set( 0, 70, 0 ); sphere2.name = 'sphere2';				
					Snowman.add( sphere2 ); 

	
					var	material =  new THREE.MeshBasicMaterial({color: 0xafeeee}); 
					var geometry = new THREE.SphereGeometry( 16, 36, 36 );
					var sphere3 = new THREE.Mesh( geometry, material);				
					sphere3.position.set( 0, 103, 0 );	sphere3.name = 'sphere3';		
					Snowman.add( sphere3 ); 

	
					var	material =  new THREE.MeshBasicMaterial({color: 0x1560bd}); 
					var geometry = new THREE.SphereGeometry( 8, 16, 16 );
					var sphere4 = new THREE.Mesh( geometry, material);	 					
					sphere4.position.set( -25, 78, 0 );		
					Snowman.add( sphere4 ); sphere4.name = 'hand right';
	
					sphere5 = new THREE.Mesh( geometry, material);	
					sphere5.position.set( 25, 78, 0 );	
					Snowman.add( sphere5 ); sphere5.name = 'hand left';
	
					// нос
   
					var	material = new THREE.MeshLambertMaterial( {color: 0xf36223} ); 
					var geometry = new THREE.CylinderGeometry( 1, 4, 20, 16 ); 
					var nose = new THREE.Mesh( geometry, material);	 	
					nose.position.set(0, 101, 23); nose.rotation.x = Math.PI / 2;
					nose.name = 'nose';
					Snowman.add( nose ); 

					// ведро
   
					var	material = new THREE.MeshLambertMaterial({color: 0x6600ff}); 
					var geometry = new THREE.CylinderGeometry( 12, 17, 30, 24 ); 
					var bucket = new THREE.Mesh( geometry, material);	 		
					bucket.position.set(0, 125, -6 );  bucket.rotation.x = -Math.PI/11;
					Snowman.add( bucket ); bucket.name = 'bucket';

					// глаза		
					var	material = new THREE.MeshLambertMaterial({color: 0x000000}); 
					var geometry = new THREE.SphereGeometry( 3, 25, 5 ); 
					var eye1 = new THREE.Mesh( geometry, material);					
					eye1.position.set( -8, 105, 13 ); eye1.name = 'eye1';		
					Snowman.add( eye1 );			

					var eye2 = new THREE.Mesh( geometry, material);	
					eye2.position.set( 8, 105, 13 ); eye2.name = 'eye2';
					Snowman.add( eye2 );		

					// рот
					var	material = new THREE.MeshBasicMaterial({color: 0x560319});
					var geometry = new THREE.CircleGeometry( 5, 5, 0, Math.PI );
					var mouth = new THREE.Mesh( geometry, material);
					mouth.rotation.z = Math.PI;
					mouth.position.set( 0, 97, 13 );
					Snowman.add( mouth ); 
					
					Snowman.name = 'Snowman';
					return Snowman;

			}


			function animate() {

					requestAnimationFrame(animate);
					render();

			}


			function render() {

					for ( var i = 0; i < EventsControls4.objects.length; i++ ) {
					
						if ( EventsControls4.objects[i].position.y < 10 ) {
							EventsControls4.objects[i].position.y += 1;
						}
						
					}

					stats.update();

					EventsControls1.update();
					EventsControls2.update();
					EventsControls3.update();
					EventsControls4.update();
					EventsControls5.update();
					EventsControls6.update();
					//EventsControls7.update();

					controls.update();
					renderer.render(scene, camera);

			}

		</script>

	</body>
</html>
